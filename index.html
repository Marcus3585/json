<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 評分報告查看器</title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 React 和 ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- 引入 Babel 用於解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 引入 PDF 生成與壓縮庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }

        /* --- 列印樣式 --- */
        @media print {
            @page { margin: 0.8cm; size: A4; }
            body { background: white; font-size: 11px; line-height: 1.4; color: #000; }
            aside, .no-print, button, input, ::-webkit-scrollbar, .web-only-header { display: none !important; }
            #root, .flex, .h-screen { display: block !important; height: auto !important; overflow: visible !important; position: static !important; }
            
            .report-page-container {
                display: block !important; width: 100% !important; height: auto !important;
                page-break-after: always; /* 強制換頁 */
                position: relative !important; margin: 0 !important; padding: 0 !important;
            }
            .report-page-container:last-child { page-break-after: auto; }

            .report-border-box {
                padding: 0 !important; margin: 0 !important; border: 2px solid #000 !important;
                box-shadow: none !important; max-width: none !important;
            }

            .web-header { display: none !important; }
            .print-header { display: table-row !important; }

            h3 {
                font-size: 13px !important; font-weight: bold !important;
                background-color: #f3f4f6 !important; border-top: 1px solid #000; border-bottom: 1px solid #000;
                padding: 4px 8px !important; margin: 0 !important; color: #000 !important; -webkit-print-color-adjust: exact;
            }
            p, li, .prose { 
                margin: 4px 8px !important; 
                text-align: justify; 
                white-space: normal !important; /* 強制換行 */
            }
            .flex.gap-3 { margin: 2px 8px !important; }
            .score-badge { border: 1px solid #000 !important; background: white !important; color: black !important; }
            .section-block { page-break-inside: avoid; }
            
            /* 表格內容強制換行修正 */
            .print-wrap-text {
                white-space: normal !important;
                overflow: visible !important;
                text-overflow: clip !important;
                word-wrap: break-word !important;
                display: block !important;
            }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // --- Icon Component ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState('');
            useEffect(() => {
                if (window.lucide && window.lucide.icons && window.lucide.icons[name]) {
                    const iconDef = window.lucide.icons[name];
                    if (typeof window.lucide.createElement === 'function') {
                        const svgElement = window.lucide.createElement(iconDef);
                        svgElement.setAttribute('width', size);
                        svgElement.setAttribute('height', size);
                        if (className) {
                            className.split(' ').forEach(cls => {
                                if (cls.trim()) svgElement.classList.add(cls.trim());
                            });
                        }
                        setSvgHtml(svgElement.outerHTML);
                    }
                }
            }, [name, size, className]);
            if (!svgHtml) return <span style={{ width: size, height: size, display: 'inline-block' }}></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} style={{ display: 'inline-flex', verticalAlign: 'middle' }} />;
        };

        // --- Helpers ---
        const safeString = (val) => {
            if (typeof val === 'string') return val;
            if (typeof val === 'number') return String(val);
            if (!val) return '';
            if (typeof val === 'object') {
                const keys = ['text', 'content', 'message', 'value', 'markdown', 'report', 'feedback'];
                for (const k of keys) if (typeof val[k] === 'string') return val[k];
                return JSON.stringify(val, null, 2);
            }
            return String(val);
        };
        const safeNumber = (val) => {
            if (typeof val === 'number') return val;
            if (typeof val === 'string') {
                const match = val.match(/(\d+(\.\d+)?)/);
                if (match) return parseFloat(match[0]);
            }
            return 0;
        };

        const getPotentialTextFields = (student) => {
            if (!student || typeof student !== 'object') return [];
            const candidates = [];
            Object.keys(student).forEach(key => {
                const val = student[key];
                if (!val) return;
                let strVal = typeof val === 'string' ? val : safeString(val);
                if (strVal.length < 20 && !key.toLowerCase().includes('feedback') && !key.toLowerCase().includes('report')) return;
                let score = 0;
                if (key.toLowerCase().includes('feedback')) score += 50;
                if (key.toLowerCase().includes('report')) score += 40;
                if (key.toLowerCase().includes('評語')) score += 50;
                if (strVal.includes('得分') || strVal.includes('Score:')) score += 20;
                if (strVal.includes('【評分結果】')) score += 100;
                if (key.toLowerCase().includes('ocr') || key.toLowerCase().includes('thinking')) score -= 100; 
                candidates.push({ key, value: strVal, score });
            });
            return candidates.sort((a, b) => b.score - a.score);
        };

        const getExtractedField = (obj, targetType) => {
            if (!obj || typeof obj !== 'object') return undefined;
            const aliases = {
                name: ['name', 'studentName', 'Name', 'Student', 'student', '姓名', '學生姓名'],
                score: ['score', 'totalScore', 'Score', 'grade', '得分', '分數', '成績', '總分'],
                id: ['id', 'studentId', 'ID', 'no', 'No', '學號', '班號'],
                class: ['class', 'className', 'Class', '班別', '班級']
            };
            const keysToCheck = aliases[targetType] || [];
            for (const key of keysToCheck) { if (obj[key]) return obj[key]; }
            const objKeys = Object.keys(obj);
            for (const key of keysToCheck) {
                const foundKey = objKeys.find(k => k.toLowerCase() === key.toLowerCase());
                if (foundKey && obj[foundKey]) return obj[foundKey];
            }
            if (['name', 'id', 'class'].includes(targetType)) {
                const allStrings = Object.values(obj).filter(v => typeof v === 'string').join('\n');
                if (targetType === 'name') {
                    const match = allStrings.match(/(?:姓名|Name)\s*[:：]\s*([^\s\n:：,，]+)/i);
                    if (match) return match[1];
                }
                if (targetType === 'class') {
                    const match = allStrings.match(/(?:班別|Class)\s*[:：]\s*([^\s\n:：,，]+)/i);
                    if (match) return match[1];
                }
                if (targetType === 'id') {
                    const match = allStrings.match(/(?:班號|學號|No\.?)\s*[:：]\s*([0-9A-Za-z]+)/i);
                    if (match) return match[1];
                }
            }
            return undefined;
        };

        const findStudentArray = (data) => {
            if (!data) return [];
            const commonKeys = ['studentReports', 'reports', 'students', 'results', 'data', 'items', 'list'];
            for (const key of commonKeys) if (Array.isArray(data[key]) && data[key].length > 0) return data[key];
            let queue = [data], visited = new Set(), bestCandidate = [], iterations = 0;
            while (queue.length > 0 && iterations < 1000) {
                iterations++;
                const current = queue.shift();
                if (!current || typeof current !== 'object' || visited.has(current)) continue;
                visited.add(current);
                if (Array.isArray(current)) {
                    if (current.length > 0 && typeof current[0] === 'object') {
                         const hasName = getExtractedField(current[0], 'name') !== undefined;
                         if (hasName) return current;
                    }
                    continue;
                }
                for (const key in current) if (typeof current[key] === 'object') queue.push(current[key]);
            }
            return bestCandidate;
        };

        // --- Structured Content ---
        const StructuredContent = ({ text }) => {
            const content = safeString(text);
            if (!content) return <div className="p-4 text-center text-gray-400">無詳細內容</div>;
            let cleanText = content
                .replace(/<thinking>[\s\S]*?<\/thinking>/gi, '')
                .replace(/^\s*Thinking\.\.\..*$/gim, '')
                .replace(/^>.*$/gm, '')
                .replace(/^AI Thinking:.*$/gim, '');
            const startMarkers = ['【評分結果】', '## 評分結果', '# 評分結果', '**評分結果**', '總分：'];
            for (const marker of startMarkers) {
                const index = cleanText.indexOf(marker);
                if (index !== -1) { cleanText = cleanText.substring(index); break; }
            }
            cleanText = cleanText.trim();
            const lines = cleanText.split('\n');
            const sections = [];
            let currentSection = { title: "總評與分析", content: [] };
            lines.forEach(line => {
                if (line.match(/^(#+\s|.*[甲乙丙丁戊己庚辛壬癸]部、|.*[A-Z] Part|Section|【.*】)/)) {
                    if (currentSection.content.length > 0) sections.push(currentSection);
                    currentSection = { title: line.replace(/^#+\s/, '').replace(/[【】]/g, ''), content: [] };
                } else { if (line.trim()) currentSection.content.push(line); }
            });
            if (currentSection.content.length > 0) sections.push(currentSection);
            return (
                <div className="w-full">
                    {sections.map((sec, idx) => (
                        <div key={idx} className="section-block border-b border-gray-200 last:border-0 pb-1 print:border-none">
                            <h3 className="text-lg font-bold text-slate-800 mt-6 mb-2 border-b border-slate-200 pb-1 flex items-center gap-2 print:text-sm print:bg-gray-100 print:mt-0 print:border-y print:border-black print:px-2">
                                <span className="hidden print:inline font-bold">{sec.title}</span>
                                <span className="print:hidden">{sec.title}</span>
                            </h3>
                            <div className="text-slate-700 leading-relaxed text-base print:text-xs">
                                {sec.content.map((line, lIdx) => {
                                    // 修正表格行的顯示，移除截斷
                                    if (line.trim().startsWith('|')) {
                                        const cells = line.split('|').filter(c => c.trim());
                                        if (line.match(/\|[\s-]*:?[\s-]*\|/)) return null;
                                        return (
                                            <div key={lIdx} className="grid grid-flow-col auto-cols-fr gap-2 border-b border-gray-100 py-1 text-sm print:text-xs print:border-gray-300 print:py-0.5">
                                                {cells.map((c, cIdx) => (
                                                    <span key={cIdx} className="px-1 truncate print:whitespace-normal print:overflow-visible print:text-wrap print:block">{c.trim()}</span>
                                                ))}
                                            </div>
                                        );
                                    }
                                    if (line.trim().match(/^[\*\-•]\s/)) {
                                        return (
                                            <div key={lIdx} className="flex gap-2 ml-2 my-1 print:my-0.5">
                                                <span className="text-gray-400 print:text-black">•</span>
                                                <span className="flex-1 print-wrap-text">{line.replace(/^[\*\-•]\s/, '')}</span>
                                            </div>
                                        );
                                    }
                                    if (line.includes('**')) {
                                        const parts = line.split(/(\*\*.*?\*\*)/g);
                                        return (
                                            <div key={lIdx} className="my-1 print:my-0.5 print-wrap-text">
                                                {parts.map((part, pIdx) => (part.startsWith('**') ? <strong key={pIdx} className="font-bold text-indigo-900 print:text-black">{part.slice(2, -2)}</strong> : <span key={pIdx}>{part}</span>))}
                                            </div>
                                        );
                                    }
                                    return <p key={lIdx} className="my-1.5 print:my-0.5 print-wrap-text">{line}</p>;
                                })}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        // --- Report Card ---
        const ReportCard = ({ student, infoObj, overrideFieldKey, idPrefix }) => {
            const assignmentName = safeString(infoObj.assignmentName || infoObj.title || "評分報告");
            const className = safeString(infoObj.className || infoObj.class || "班級未知");
            const maxScore = safeNumber(infoObj.maxScore || 100);
            const sName = safeString(getExtractedField(student, 'name')) || "未命名";
            const sScore = safeNumber(getExtractedField(student, 'score'));
            const sClass = safeString(getExtractedField(student, 'class'));
            const sId = safeString(getExtractedField(student, 'id'));
            const contentCandidates = useMemo(() => getPotentialTextFields(student), [student]);
            const activeContent = overrideFieldKey ? contentCandidates.find(c => c.key === overrideFieldKey) : contentCandidates[0];

            return (
                <div id={idPrefix} className="report-page-container w-full h-full bg-white print:h-auto">
                    <div className="report-border-box max-w-4xl mx-auto bg-white shadow-lg print:shadow-none print:w-full print:max-w-none">
                        {/* Print Header */}
                        <div className="hidden print:table w-full border-b-2 border-black mb-0">
                            <div className="table-row">
                                <div className="table-cell p-2 border-r border-black w-1/4 bg-gray-200 font-bold text-center align-middle">姓名</div>
                                <div className="table-cell p-2 border-r border-black w-1/4 align-middle text-center text-lg font-bold">{sName}</div>
                                <div className="table-cell p-2 border-r border-black w-1/4 bg-gray-200 font-bold text-center align-middle">成績</div>
                                <div className="table-cell p-2 w-1/4 align-middle text-center text-xl font-bold">{sScore} / {maxScore}</div>
                            </div>
                            <div className="table-row border-t border-black">
                                <div className="table-cell p-1 border-r border-black bg-gray-100 text-center text-xs">班級</div>
                                <div className="table-cell p-1 border-r border-black text-center text-xs">{sClass || '-'}</div>
                                <div className="table-cell p-1 border-r border-black bg-gray-100 text-center text-xs">學號</div>
                                <div className="table-cell p-1 text-center text-xs">{sId || '-'}</div>
                            </div>
                            <div className="table-row border-t border-black">
                                <div className="table-cell p-1 border-r border-black bg-gray-100 text-center text-xs">作業名稱</div>
                                <div className="table-cell p-1 text-center text-xs" colSpan="3">{assignmentName}</div>
                            </div>
                        </div>

                        {/* Web Header */}
                        <div className="web-header bg-slate-900 text-white p-6 rounded-t-lg print:hidden">
                            <div className="flex justify-between items-start">
                                <div>
                                    <div className="text-indigo-300 text-xs font-bold uppercase mb-1">Assessment Report</div>
                                    <h2 className="text-3xl font-bold">{sName}</h2>
                                    <p className="opacity-80 text-sm mt-1">{assignmentName} | {sClass} | #{sId}</p>
                                </div>
                                <div className="text-right">
                                    <div className="text-5xl font-bold">{sScore}</div>
                                    <div className="text-sm opacity-75">滿分: {maxScore}</div>
                                </div>
                            </div>
                        </div>

                        {/* Content */}
                        <div className="p-8 print:p-0">
                            <StructuredContent text={activeContent?.value} />
                        </div>
                        <div className="p-8 pt-0 text-center text-xs text-gray-400 print:hidden">Generated by AI • {new Date().toLocaleDateString()}</div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [data, setData] = useState(null);
            const [students, setStudents] = useState([]);
            const [selectedStudentIndex, setSelectedStudentIndex] = useState(0);
            const [searchTerm, setSearchTerm] = useState('');
            const [overrideFieldKey, setOverrideFieldKey] = useState(null);
            const [viewMode, setViewMode] = useState('single');
            const [isExporting, setIsExporting] = useState(false);
            const [exportProgress, setExportProgress] = useState(0);

            const processFile = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        setData(json);
                        const foundStudents = findStudentArray(json);
                        setStudents(foundStudents);
                        setSelectedStudentIndex(0);
                    } catch (err) { alert("JSON 解析失敗"); }
                };
                reader.readAsText(file);
            };

            const infoObj = data?.assignmentInfo || data || {};
            const assignmentName = safeString(infoObj.assignmentName || infoObj.title || "評分報告");
            const className = safeString(infoObj.className || infoObj.class || "班級未知");

            const stats = useMemo(() => {
                if (!students.length) return null;
                const scores = students.map(s => safeNumber(getExtractedField(s, 'score')));
                const total = scores.reduce((a, b) => a + b, 0);
                return { avg: (total/scores.length).toFixed(1), max: Math.max(...scores), count: scores.length };
            }, [students]);

            const filteredStudents = useMemo(() => students.filter(s => safeString(getExtractedField(s, 'name')).toLowerCase().includes(searchTerm.toLowerCase())), [students, searchTerm]);

            // Keyboard nav
            useEffect(() => {
                if(viewMode === 'all') return;
                const handleKey = (e) => {
                    if (!students.length) return;
                    if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
                        const cur = students[selectedStudentIndex];
                        const fIdx = filteredStudents.indexOf(cur);
                        if (fIdx !== -1 && fIdx + 1 < filteredStudents.length) setSelectedStudentIndex(students.indexOf(filteredStudents[fIdx + 1]));
                    } else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
                        const cur = students[selectedStudentIndex];
                        const fIdx = filteredStudents.indexOf(cur);
                        if (fIdx > 0) setSelectedStudentIndex(students.indexOf(filteredStudents[fIdx - 1]));
                    }
                };
                window.addEventListener('keydown', handleKey);
                return () => window.removeEventListener('keydown', handleKey);
            }, [students, filteredStudents, selectedStudentIndex, viewMode]);

            useEffect(() => {
                if(viewMode === 'all') return;
                const el = document.getElementById(`student-btn-${selectedStudentIndex}`);
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, [selectedStudentIndex, viewMode]);

            // --- ZIP Export Logic ---
            const handleExportZip = async () => {
                setIsExporting(true);
                setExportProgress(0);
                
                const originalMode = viewMode;
                setViewMode('all');
                await new Promise(resolve => setTimeout(resolve, 1000));

                const zip = new JSZip();
                const total = filteredStudents.length;

                try {
                    for (let i = 0; i < total; i++) {
                        const student = filteredStudents[i];
                        const sName = safeString(getExtractedField(student, 'name')) || `Student${i}`;
                        const sId = safeString(getExtractedField(student, 'id')) || `${i}`;
                        const element = document.getElementById(`report-card-${i}`);
                        if (!element) continue;

                        const opt = {
                            margin: [10, 10],
                            filename: `${sName}.pdf`,
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: { scale: 2, useCORS: true, logging: false },
                            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                        };

                        const blob = await html2pdf().from(element).set(opt).output('blob');
                        zip.file(`${sName}_${sId}.pdf`, blob);
                        setExportProgress(Math.round(((i + 1) / total) * 100));
                        await new Promise(r => setTimeout(r, 100));
                    }

                    const content = await zip.generateAsync({ type: "blob" });
                    saveAs(content, `${assignmentName}_全部報告.zip`);

                } catch (err) {
                    console.error(err);
                    alert("匯出過程發生錯誤，請重試");
                } finally {
                    setIsExporting(false);
                    setViewMode(originalMode);
                }
            };

            if (!data) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 p-6">
                    <div className="bg-white p-12 rounded-xl shadow-lg border border-slate-200 text-center max-w-lg w-full">
                        <Icon name="FileText" size={48} className="text-indigo-600 mb-4 mx-auto"/>
                        <h1 className="text-2xl font-bold mb-2">AI 評分報告系統</h1>
                        <p className="text-slate-500 mb-6">請上傳 JSON 報告檔案</p>
                        <input type="file" accept=".json" onChange={e => e.target.files[0] && processFile(e.target.files[0])} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                    </div>
                </div>
            );

            // --- View: Batch Mode ---
            if (viewMode === 'all') {
                return (
                    <div className="bg-slate-100 min-h-screen">
                        {/* Loading Overlay */}
                        {isExporting && (
                            <div className="fixed inset-0 bg-black/80 z-[100] flex flex-col items-center justify-center text-white">
                                <Icon name="Loader2" size={48} className="animate-spin mb-4"/>
                                <h2 className="text-2xl font-bold mb-2">正在生成 PDF...</h2>
                                <p className="mb-4">請勿關閉視窗 ({exportProgress}%)</p>
                                <div className="w-64 h-2 bg-gray-700 rounded-full overflow-hidden">
                                    <div className="h-full bg-indigo-500 transition-all duration-300" style={{width: `${exportProgress}%`}}></div>
                                </div>
                            </div>
                        )}

                        <div className="fixed top-0 left-0 w-full bg-slate-800 text-white p-4 flex justify-between items-center shadow-md z-50 no-print">
                            <h2 className="font-bold flex items-center gap-2"><Icon name="Files" size={20}/> 全班列印預覽 ({filteredStudents.length} 位學生)</h2>
                            <div className="flex gap-3">
                                <button onClick={() => setViewMode('single')} disabled={isExporting} className="bg-slate-600 hover:bg-slate-500 px-4 py-2 rounded text-sm flex items-center gap-2 disabled:opacity-50">
                                    <Icon name="ArrowLeft" size={16}/> 返回
                                </button>
                                <button onClick={handleExportZip} disabled={isExporting} className="bg-green-600 hover:bg-green-500 px-4 py-2 rounded text-sm font-bold flex items-center gap-2 disabled:opacity-50">
                                    <Icon name="FileArchive" size={16}/> 批次下載 PDF (ZIP)
                                </button>
                                <button onClick={() => window.print()} disabled={isExporting} className="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded text-sm font-bold flex items-center gap-2 disabled:opacity-50">
                                    <Icon name="Printer" size={16}/> 直接列印
                                </button>
                            </div>
                        </div>
                        
                        <div className="pt-20 pb-10 px-4 max-w-4xl mx-auto space-y-8 print:pt-0 print:px-0 print:space-y-0 print:max-w-none">
                            {filteredStudents.map((s, idx) => (
                                <div key={idx} className="print:block">
                                    <ReportCard 
                                        idPrefix={`report-card-${idx}`}
                                        student={s} 
                                        infoObj={data?.assignmentInfo || data} 
                                        overrideFieldKey={overrideFieldKey} 
                                    />
                                    <div className="h-8 print:hidden"></div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            // --- View: Single Mode ---
            return (
                <div className="flex h-screen overflow-hidden bg-slate-100 font-sans">
                    <aside className="w-72 bg-white border-r border-gray-200 flex flex-col shrink-0">
                        <div className="p-4 border-b bg-gray-50">
                            <h2 className="font-bold text-lg mb-1 truncate">{assignmentName}</h2>
                            <div className="flex justify-between text-xs text-gray-500 mb-3"><span>{className}</span><span>均分: {stats?.avg}</span></div>
                            <button onClick={() => setViewMode('all')} className="w-full bg-indigo-100 text-indigo-700 hover:bg-indigo-200 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 mb-3 transition-colors">
                                <Icon name="Files" size={16}/> 進入批次匯出模式
                            </button>
                            <div className="relative">
                                <Icon name="Search" size={14} className="absolute left-3 top-2.5 text-gray-400"/>
                                <input type="text" placeholder="搜尋學生..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full border rounded-lg pl-9 pr-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"/>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto custom-scrollbar">
                            {filteredStudents.map((s) => {
                                const idx = students.indexOf(s);
                                const isActive = idx === selectedStudentIndex;
                                return (
                                    <div key={idx} id={`student-btn-${idx}`} onClick={() => setSelectedStudentIndex(idx)} className={`px-4 py-3 border-b cursor-pointer flex justify-between items-center hover:bg-gray-50 ${isActive ? 'bg-indigo-50 border-l-4 border-l-indigo-600' : ''}`}>
                                        <div><div className={`font-medium ${isActive ? 'text-indigo-900' : 'text-gray-700'}`}>{safeString(getExtractedField(s, 'name'))}</div><div className="text-xs text-gray-400">#{safeString(getExtractedField(s, 'id')) || idx+1}</div></div>
                                        <div className={`font-bold ${safeNumber(getExtractedField(s, 'score'))>=60?'text-green-600':'text-red-500'}`}>{safeNumber(getExtractedField(s, 'score'))}</div>
                                    </div>
                                );
                            })}
                        </div>
                    </aside>

                    <main className="flex-1 overflow-y-auto p-8 bg-slate-100" id="report-viewer">
                        {students[selectedStudentIndex] ? (
                            <ReportCard student={students[selectedStudentIndex]} infoObj={data?.assignmentInfo || data} overrideFieldKey={overrideFieldKey} />
                        ) : <div className="flex flex-col items-center justify-center h-full text-gray-400"><Icon name="User" size={48} className="mb-4 opacity-30"/><p>請選擇學生</p></div>}
                    </main>

                    <button onClick={() => window.print()} className="fixed bottom-8 right-8 bg-slate-800 text-white p-4 rounded-full shadow-xl hover:bg-slate-700 print:hidden z-50" title="列印當前報告"><Icon name="Printer" size={24} /></button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
